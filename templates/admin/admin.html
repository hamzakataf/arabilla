{% load static %}
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel - Arabella</title>
  <link rel="stylesheet" href="{% static 'css/styles.css' %}" />
  <link rel="stylesheet" href="{% static 'css/admin.css' %}" />

  <style>
    /* Toast Ø¨Ø³ÙŠØ· Ø¨Ø¯ÙˆÙ† Ù…Ø§ Ù†ÙƒØ³Ø± Ø³ØªØ§ÙŠÙ„Ùƒ */
    .toast{
      position: fixed;
      top: 18px;
      left: 18px;
      z-index: 9999;
      background: rgba(17,17,20,.95);
      color:#fff;
      border: 1px solid rgba(183,122,85,.35);
      padding: 12px 14px;
      border-radius: 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      display:none;
      max-width: 360px;
      font-weight: 800;
    }

    /* ØªØ­Ø³ÙŠÙ† Ø¨Ø³ÙŠØ· Ù„Ø³Ø·Ø± Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù„ÙŠØ­Ù…Ù„ 4 Ø£Ø¹Ù…Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ù…Ø§ Ù†Ø®Ø±Ø¨ Ø³ØªØ§ÙŠÙ„Ùƒ */
    .order-line{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 6px 0;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .order-line:last-child{ border-bottom:0; }

    .order-cols{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content: space-between;
      width: 100%;
    }
    .col-name{ flex: 1; font-weight: 900; }
    .col-price, .col-qty, .col-total{
      white-space: nowrap;
      font-weight: 900;
      font-size: 12px;
      opacity: .9;
    }
    .col-total{ color: var(--accent); font-size: 12px; }

    .order-sum{
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed rgba(255,255,255,.12);
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
      font-weight: 1000;
    }
    .order-sum .sum-v{
      color: var(--accent);
      font-size: 14px;
    }
  </style>
</head>
<body>

  <div class="toast" id="toast">ğŸš¨ ÙˆØµÙ„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</div>

  <div class="admin">
    <aside class="sidebar">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div class="b1">Arabella</div>
          <div class="b2">Admin Panel</div>
        </div>
      </div>

      <nav class="nav">
        <a class="nav-item is-active" href="{% url 'admin_dashboard' %}">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</a>
        <a class="nav-item" href="/admin/">Django Admin</a>
        <a class="nav-item" href="#" onclick="return false;">Ø§Ù„Ø£ØµÙ†Ø§Ù</a>
        <a class="nav-item" href="#" onclick="return false;">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a>
      </nav>

      <div class="side-footer">
        <div class="small text-muted">Ø§Ù„Ø­Ø§Ù„Ø©: Online</div>
      </div>
    </aside>

    <main class="admin-main">
      <header class="topbar">
        <div class="top-left">
          <h1>Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª</h1>
          <div class="hint">Ø£ÙŠ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ø±Ø­ ÙŠØ¸Ù‡Ø± Ù‡ÙˆÙ† (Ø¨Ø¯ÙˆÙ† ØµÙˆØ±)</div>
        </div>

        <div class="top-actions">
          <button class="btn btn-accent btn-sm" type="button" onclick="location.reload()">ØªØ­Ø¯ÙŠØ«</button>
        </div>
      </header>

      <section class="stats">
        <div class="stat">
          <div class="k">Ø·Ù„Ø¨Ø§Øª Ù…ÙØªÙˆØ­Ø©</div>
          <div class="v">{{ open_orders }}</div>
        </div>
        <div class="stat">
          <div class="k">Ø·Ø§ÙˆÙ„Ø§Øª ÙØ¹Ù‘Ø§Ù„Ø©</div>
          <div class="v">{{ active_tables }}</div>
        </div>
        <div class="stat">
          <div class="k">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</div>
          <div class="v">Ø§Ù„Ø¢Ù†</div>
        </div>
      </section>

      <section class="tables">
        {% for o in orders %}
          <article class="table-card">
            <div class="table-head">
              <div class="tno">Ø·Ø§ÙˆÙ„Ø© #{{ o.table_no }}</div>

              {% if o.status == 'new' %}
                <div class="badge new">NEW</div>
              {% elif o.status == 'preparing' %}
                <div class="badge">Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±</div>
              {% elif o.status == 'ready' %}
                <div class="badge">Ø¬Ø§Ù‡Ø²</div>
              {% elif o.status == 'delivered' %}
                <div class="badge">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</div>
              {% else %}
                <div class="badge">{{ o.status|upper }}</div>
              {% endif %}
            </div>

            <div class="orders">
              <!-- Header Ø³Ø·Ø± Ù„Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† -->
              <div class="order-line" style="opacity:.75;">
                <div class="order-cols">
                  <span class="col-type">Ù†ÙˆØ¹</span>
<span class="col-name">
  {{ it.name_snapshot }}
  {% if it.item_type == 'offer' %}
    <span class="badge" style="margin-inline-start:8px;">Ø¹Ø±Ø¶</span>
  {% else %}
    <span class="badge" style="margin-inline-start:8px;">Ù…Ù†ØªØ¬</span>
  {% endif %}

  {% if it.note_snapshot %}
    <div class="small" style="opacity:.75; margin-top:4px;">{{ it.note_snapshot }}</div>
  {% endif %}
</span>
                  <span class="col-price">Ø³Ø¹Ø±</span>
                  <span class="col-qty">ÙƒÙ…ÙŠØ©</span>
                  <span class="col-total">Ù…Ø¬Ù…ÙˆØ¹</span>
                </div>
              </div>

              {% for it in o.items.all %}
                <div class="order-line">
                  <div class="order-cols">
                    <span class="col-type">{% if it.item_type == 'offer' %}Ø¹Ø±Ø¶{% else %}Ù…Ù†ØªØ¬{% endif %}</span>

                    <span class="col-name">
                      {{ it.name_snapshot }}
                      {% if it.note_snapshot %}
                        <div class="small text-muted" style="margin-top:4px;">{{ it.note_snapshot }}</div>
                      {% endif %}
                    </span>

                    <span class="col-price">{{ it.price_syp_snapshot }} Ù„.Ø³</span>
                    <span class="col-qty">x{{ it.qty }}</span>
                    <span class="col-total">{{ it.line_total }} Ù„.Ø³</span>
                  </div>
                </div>


              {% empty %}
                <div class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ø¶Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨</div>
              {% endfor %}

              <!-- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨ -->
              <div class="order-sum">
                <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
                <span class="sum-v">
                  {% if o.total_syp and o.total_syp > 0 %}
                    {{ o.total_syp }} Ù„.Ø³
                  {% else %}
                    {# fallback Ø¨Ø³ÙŠØ·: Ø§Ø·Ø¨Ø¹ 0 Ø¥Ø°Ø§ Ù…Ø§ ÙƒØ§Ù† Ù…Ø­Ø³ÙˆØ¨ #}
                    0 Ù„.Ø³
                  {% endif %}
                </span>
              </div>

              {% if o.note %}
                <div class="order-note">
                  <strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> {{ o.note }}
                </div>
              {% endif %}
            </div>

            <div class="table-actions">
              <form method="post" action="{% url 'admin_set_status' o.id %}">
                {% csrf_token %}
                <input type="hidden" name="status" value="preparing">
                <button class="btn btn-accent-outline btn-sm" type="submit">Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±</button>
              </form>

              <form method="post" action="{% url 'admin_set_status' o.id %}">
                {% csrf_token %}
                <input type="hidden" name="status" value="ready">
                <button class="btn btn-accent-outline btn-sm" type="submit">Ø¬Ø§Ù‡Ø²</button>
              </form>

              <form method="post" action="{% url 'admin_done' o.id %}">
                {% csrf_token %}
                <button class="btn btn-accent btn-sm" type="submit">ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° / Ø¥ÙØ±Ø§Øº</button>
              </form>
            </div>
          </article>
        {% empty %}
          <div class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>
        {% endfor %}
      </section>
    </main>
  </div>

  <script>
    const serverMaxId = Number("{{ max_order_id|default:0 }}") || 0;
    const key = "admin_last_seen_order_id";
    const lastSeen = Number(localStorage.getItem(key) || "0");

    if (lastSeen === 0 && serverMaxId > 0) {
      localStorage.setItem(key, String(serverMaxId));
    } else if (serverMaxId > lastSeen) {
      localStorage.setItem(key, String(serverMaxId));
      const toast = document.getElementById("toast");
      toast.style.display = "block";
      setTimeout(() => toast.style.display = "none", 2500);
    }

    setInterval(() => location.reload(), 5000);
  </script>

</body>
</html>
